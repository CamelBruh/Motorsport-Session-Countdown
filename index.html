<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Session Countdown</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }
    body.dark {
      background: #121212;
      color: #e0e0e0;
    }
    h1 {
      text-align: center;
    }
    .form-container {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-width: 600px;
      margin: 0 auto 30px auto;
    }
    body.dark .form-container {
      background: #1e1e1e;
      box-shadow: 0 0 10px rgba(255,255,255,0.1);
    }
    .countdowns {
      max-width: 800px;
      margin: auto;
    }
    .countdown {
      background: #fff;
      padding: 15px;
      margin-bottom: 10px;
      border-left: 8px solid;
      border-radius: 8px;
      transition: border-color 0.3s, background 0.3s;
    }
    body.dark .countdown {
      background: #1e1e1e;
    }
    input, button {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      font-size: 1rem;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }
    .before { border-color: red; }
    .during { border-color: green; }
    .after { border-color: gray; }
    .btn-group {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }
    .btn-group button {
      flex: 1;
      cursor: pointer;
    }
    .dark-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 8px 14px;
      cursor: pointer;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    .quick-pick-buttons button {
      padding: 10px;
      font-size: 1rem;
      cursor: pointer;
      margin: 5px;
      border: none;
      background-color: #3498db;
      color: white;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }

    .quick-pick-buttons button:hover {
      background-color: #2980b9;
    }

        /* Position the buttons in the top-left corner */
    .top-buttons {
      position: absolute;
      top: 10px;
      left: 10px;
      display: flex;
      gap: 10px;
      z-index: 999;
    }

    /* Small button styling */
    .btn {
      padding: 8px 12px;
      font-size: 0.9rem;
      cursor: pointer;
      border: none;
      background-color: #3498db;
      color: white;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }

    .btn:hover {
      background-color: #2980b9;
    }

    /* Dark mode toggle button */
    #darkModeToggle {
      background-color: #2c3e50;
    }

    #darkModeToggle:hover {
      background-color: #34495e;
    }
  </style>
</head>
<body>
  <h1>Session Countdown Form</h1>
  <div class="top-buttons">
    <button onclick="window.open('display.html', '_blank')" class="btn" id="openDisplayBtn">
      Live Countdown
    </button>
    <button onclick="toggleDarkMode()" class="btn" id="darkModeToggle">
      Dark Mode
    </button>
  </div>
  <div class="form-container">
    <form id="countdownForm">
      <input type="hidden" id="editIndex" value="">
      <label for="eventName">Session Name</label>
      <input type="text" id="eventName" required>

      <label for="startDate">Start Date & Time</label>
      <input type="datetime-local" id="startDate" required>
      
      <label for="sessionTime">Session Duration (minutes)</label>
      <input type="number" id="sessionTime" min="1" value="60" required>

      <div class="quick-pick-buttons">
        <button type="button" onclick="setSessionTime(10)">10 mins</button>
        <button type="button" onclick="setSessionTime(20)">20 mins</button>
        <button type="button" onclick="setSessionTime(30)">30 mins</button>
        <button type="button" onclick="setSessionTime(60)">60 mins</button>
        <button type="button" onclick="setSessionTime(90)">90 mins</button>
        <button type="button" onclick="setSessionTime(120)">2 Hours</button>
        <button type="button" onclick="setSessionTime(180)">3 Hours</button>
        <button type="button" onclick="setSessionTime(360)">6 Hours</button>
        <button type="button" onclick="setSessionTime(720)">12 Hours</button>
      </div>      

      <label for="endDate">End Date & Time</label>
      <input type="datetime-local" id="endDate" required>

      <button type="submit" id="submitBtn">Add Countdown</button>
    </form>
  </div>

  <div class="countdowns" id="countdownList"></div>

  <script>
    const form = document.getElementById("countdownForm");
    const countdownList = document.getElementById("countdownList");
    const submitBtn = document.getElementById("submitBtn");
    const countdowns = loadFromStorage();

    form.addEventListener("submit", function(e) {
      e.preventDefault();
      const name = document.getElementById("eventName").value;
      const startDate = new Date(document.getElementById("startDate").value);
      const endDate = new Date(document.getElementById("endDate").value);
      const editIndex = document.getElementById("editIndex").value;

      if (startDate >= endDate) {
        alert("End date/time must be after start date/time.");
        return;
      }

      if (endDate <= new Date()) {
        alert("Event must end in the future.");
        return;
      }

      const eventObj = { name, startDate: startDate.toISOString(), endDate: endDate.toISOString() };

      if (editIndex === "") {
        countdowns.push(eventObj);
      } else {
        countdowns[parseInt(editIndex)] = eventObj;
        document.getElementById("editIndex").value = "";
        submitBtn.textContent = "Add Countdown";
      }

      saveToStorage();
      form.reset();
      setDefaultDateTime();
      updateCountdowns();
    });

    function updateCountdowns() {
      countdownList.innerHTML = '';
      const now = new Date();

      countdowns.sort((a, b) => getStatusSortKey(a, now) - getStatusSortKey(b, now));

      countdowns.forEach((event, index) => {
        const start = new Date(event.startDate);
        const end = new Date(event.endDate);
        const now = new Date();

        let status = "";
        let countdownText = "";
        let borderClass = "";

        if (now < start) {
          countdownText = formatTimeLeft(start - now) + " until start";
          status = "Upcoming";
          borderClass = "before";
        } else if (now >= start && now < end) {
          countdownText = formatTimeLeft(end - now) + " until end";
          status = "Live Now";
          borderClass = "during";
        } else {
          countdownText = "Event Finished!";
          status = "Completed";
          borderClass = "after";
        }

        countdownList.innerHTML += `
          <div class="countdown ${borderClass}">
            <strong>${event.name}</strong><br>
            <small>${start.toLocaleString()} ‚Üí ${end.toLocaleString()}</small><br>
            <em>${status}</em><br>
            ${countdownText}
            <div class="btn-group">
              <button onclick="editCountdown(${index})">‚úèÔ∏è Edit</button>
              <button onclick="deleteCountdown(${index})">üóëÔ∏è Delete</button>
            </div>
          </div>
        `;
      });
    }

    function formatTimeLeft(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const days = Math.floor(totalSeconds / 86400);
      const hours = Math.floor((totalSeconds % 86400) / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      return `${days}d ${hours}h ${minutes}m ${seconds}s`;
    }

    function getStatusSortKey(event, now) {
      const start = new Date(event.startDate);
      const end = new Date(event.endDate);
      if (now < start) return start.getTime();
      if (now >= start && now < end) return now.getTime() - 100000;
      return end.getTime() + 1000000000;
    }

    function deleteCountdown(index) {
      countdowns.splice(index, 1);
      saveToStorage();
      updateCountdowns();
    }

    function editCountdown(index) {
      const event = countdowns[index];
      document.getElementById("eventName").value = event.name;
      document.getElementById("startDate").value = toInputDateTime(new Date(event.startDate));
      document.getElementById("endDate").value = toInputDateTime(new Date(event.endDate));
      document.getElementById("editIndex").value = index;
      submitBtn.textContent = "Update Countdown";
    }

    function toInputDateTime(date) {
      const offset = date.getTimezoneOffset();
      const local = new Date(date.getTime() - offset * 60000);
      return local.toISOString().slice(0, 16);
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark');
    }

    function saveToStorage() {
      localStorage.setItem("motorsportCountdowns", JSON.stringify(countdowns));
    }

    function loadFromStorage() {
      const saved = localStorage.getItem("motorsportCountdowns");
      if (!saved) return [];
      const parsed = JSON.parse(saved);
      return parsed.map(e => ({
        name: e.name,
        startDate: e.startDate,
        endDate: e.endDate
      }));
    }

    function setDefaultDateTime() {
      const now = new Date();
      const defaultDuration = 60;
      const oneHourLater = new Date(now.getTime() + defaultDuration * 60 * 1000);

      const toLocalISOString = (date) =>
        new Date(date.getTime() - date.getTimezoneOffset() * 60000)
          .toISOString()
          .slice(0, 16);

      document.getElementById("startDate").value = toLocalISOString(now);
      document.getElementById("sessionTime").value = defaultDuration;
      document.getElementById("endDate").value = toLocalISOString(oneHourLater);
    }

    function updateEndDateFromSession() {
      const startInput = document.getElementById("startDate").value;
      const sessionMinutes = parseInt(document.getElementById("sessionTime").value, 10);

      if (!startInput || isNaN(sessionMinutes)) return;

      const startDate = new Date(startInput);
      const endDate = new Date(startDate.getTime() + sessionMinutes * 60 * 1000);

      const toLocalISOString = (date) =>
        new Date(date.getTime() - date.getTimezoneOffset() * 60000)
          .toISOString()
          .slice(0, 16);

      document.getElementById("endDate").value = toLocalISOString(endDate);
    }

    function setSessionTime(minutes) {
      document.getElementById("sessionTime").value = minutes;
      updateEndDateFromSession(); // Update the end time based on session time
    }

    document.getElementById("startDate").addEventListener("change", updateEndDateFromSession);
    document.getElementById("sessionTime").addEventListener("input", updateEndDateFromSession);

    // Initial render
    updateCountdowns();
    setDefaultDateTime()
    toggleDarkMode()
    setInterval(updateCountdowns, 1000);
  </script>
</body>
</html>
